<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Crowd Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: #333;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        .stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }

        .stat-box {
            background: #444;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .stat-value {
            font-weight: bold;
            color: #4caf50;
        }

        .stat-value.danger {
            color: #f44336;
        }

        #map {
            flex-grow: 1;
            width: 100%;
            height: 100%;
        }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            font-size: 0.8rem;
        }

        .dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .green {
            background: green;
        }

        .red {
            background: red;
        }
    </style>
</head>

<body>

    <header>
        <h1>Crowd Management Dashboard</h1>
        <div class="stats">
            <div class="stat-box">Active Users: <span id="total-users" class="stat-value">0</span></div>
            <div class="stat-box">Crowd Zones: <span id="crowd-zones" class="stat-value danger">0</span></div>
        </div>
    </header>

    <div id="map"></div>

    <div class="legend">
        <div><span class="dot green"></span> Normal</div>
        <div><span class="dot red"></span> High Crowd (> 5 users)</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // Initialize Map
        // Default view: global or a default location. 
        // We will auto-center on first user or keep it generic.
        // Let's start with a world view or a specific city if known. 
        // Since it's local, 0,0 is fine, but maybe user wants to see something. 
        // We'll update bounds based on users.
        const map = L.map('map').setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let markers = {};

        async function fetchLocations() {
            try {
                const response = await fetch('/current-locations');
                const data = await response.json();

                // Update stats
                document.getElementById('total-users').innerText = data.total_active;
                document.getElementById('crowd-zones').innerText = data.crowd_zones;

                // Update markers
                const currentIds = new Set();
                const bounds = [];

                data.users.forEach(user => {
                    currentIds.add(user.id);
                    const color = user.is_crowded ? 'red' : 'green';
                    const radius = user.is_crowded ? 8 : 5;

                    if (markers[user.id]) {
                        // Update existing
                        markers[user.id].setLatLng([user.latitude, user.longitude]);
                        markers[user.id].setStyle({ color: color, fillColor: color, radius: radius });
                        markers[user.id].bindPopup(`<b>${user.name}</b><br>Values: ${user.latitude.toFixed(4)}, ${user.longitude.toFixed(4)}`);
                    } else {
                        // Create new
                        const marker = L.circleMarker([user.latitude, user.longitude], {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.8,
                            radius: radius
                        }).addTo(map);
                        marker.bindPopup(`<b>${user.name}</b><br>ID: ${user.id}`);
                        markers[user.id] = marker;
                    }
                    bounds.push([user.latitude, user.longitude]);
                });

                // Remove old markers
                for (let id in markers) {
                    if (!currentIds.has(parseInt(id))) {
                        map.removeLayer(markers[id]);
                        delete markers[id];
                    }
                }

                // Auto-fit bounds if we have users and haven't moved manually too much?
                // Actually, continuously fitting bounds is annoying if admin is panning.
                // Let's fit bounds only on first load with data?
                // Or if user asks. For now, let's not auto-fit repeatedly.
                if (bounds.length > 0 && !window.hasFitBounds) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                    window.hasFitBounds = true;
                }

            } catch (e) {
                console.error("Error fetching locations:", e);
            }
        }

        // Poll every 5 seconds
        setInterval(fetchLocations, 5000);
        fetchLocations(); // Initial call
    </script>

</body>

</html>